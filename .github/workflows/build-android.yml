name: Build Android APK and AAB

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true
    
    - name: Prepare build directory
      run: |
        mkdir -p snap-beam
        echo "âœ… Build directory created"
    
    - name: Copy Flutter app
      run: |
        cp -r download/snapbeam/flutter-app/* snap-beam/
        ls -la snap-beam/
        echo "âœ… Flutter app copied"
    
    - name: Validate Flutter setup
      run: |
        cd snap-beam
        flutter --version
        flutter doctor -v
    
    - name: Get dependencies
      run: |
        cd snap-beam
        flutter clean
        flutter pub get
        echo "âœ… Dependencies resolved"
    
    - name: Generate localization files
      run: |
        cd snap-beam
        flutter gen-l10n --output-localization-file=app_localizations.dart
        echo "âœ… Localization files generated"
      continue-on-error: true
    
    - name: Build APK (Debug first)
      run: |
        cd snap-beam
        flutter build apk --debug 2>&1
        echo "âœ… Debug APK built"
        find . -path "*build/app/outputs*" -name "*.apk" -type f
      continue-on-error: true
    
    - name: Build APK (Release)
      run: |
        cd snap-beam
        echo "Building Release APK..."
        flutter build apk --release 2>&1
        echo "âœ… Release APK built"
        echo "APK output location:"
        find . -path "*build/app/outputs*" -name "*.apk" -type f
    
    - name: Build AAB (Release)
      run: |
        cd snap-beam
        echo "Building Release AAB..."
        flutter build appbundle --release 2>&1
        echo "âœ… Release AAB built"
        echo "AAB output location:"
        find . -path "*build/app/outputs*" -name "*.aab" -type f
    
    - name: Check APK outputs
      if: always()
      run: |
        echo "APK outputs:"
        find snap-beam -name "*.apk" -type f 2>/dev/null || echo "No APK found"
        echo ""
        echo "AAB outputs:"
        find snap-beam -name "*.aab" -type f 2>/dev/null || echo "No AAB found"
        echo ""
        echo "Build directory structure:"
        find snap-beam/build -type f -name "*.apk" -o -name "*.aab" 2>/dev/null || echo "No artifacts in build"
    
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: snapbeam-apk-release
        path: snap-beam/build/app/outputs/apk/release/
        retention-days: 30
    
    - name: Upload AAB Artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: snapbeam-aab-release
        path: snap-beam/build/app/outputs/bundle/release/
        retention-days: 30
    
    - name: Build Summary
      if: always()
      run: |
        echo "======================================"
        echo "ðŸ“Š Build Summary"
        echo "======================================"
        echo "Check artifacts in GitHub Actions!"
        echo "APK: snapbeam-apk-release"
        echo "AAB: snapbeam-aab-release"
