name: Build Android APK and AAB

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
    
    - name: Copy Flutter app
      run: |
        mkdir -p snap-beam
        cp -r download/snapbeam/flutter-app/* snap-beam/
        cd snap-beam
        echo "Flutter app copied"
        ls -la
    
    - name: Flutter doctor
      run: flutter doctor -v
    
    - name: Get dependencies
      run: |
        cd snap-beam
        flutter pub get
    
    - name: Build APK Release
      run: |
        cd snap-beam
        set -x
        flutter build apk --release -v
        BUILD_RESULT=$?
        echo "Build exited with code: $BUILD_RESULT"
        find build -type f \( -name "*.apk" -o -name "*.aab" \) 2>/dev/null || true
        exit $BUILD_RESULT
    
    - name: Build AAB Release
      run: |
        cd snap-beam
        set -x
        flutter build appbundle --release -v
        BUILD_RESULT=$?
        echo "Build exited with code: $BUILD_RESULT"
        find build -type f \( -name "*.apk" -o -name "*.aab" \) 2>/dev/null || true
        exit $BUILD_RESULT
    
    - name: Find all artifacts
      if: always()
      run: |
        echo "=== Searching for APK and AAB files ==="
        find snap-beam/build -type f \( -name "*.apk" -o -name "*.aab" \) 2>/dev/null | sort || echo "No APK/AAB found"
        echo ""
        echo "=== Build outputs directory ==="
        ls -R snap-beam/build/app/outputs/ 2>/dev/null || echo "No outputs directory"
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: apk-files
        path: snap-beam/build/app/outputs/apk/
        if-no-files-found: warn
    
    - name: Upload AAB
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: aab-files
        path: snap-beam/build/app/outputs/bundle/
        if-no-files-found: warn
